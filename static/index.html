<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Empfänger-Erkennung</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2em;
            color: #333;
            font-weight: 500;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 60px 20px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #999;
            background: #f5f5f5;
        }

        .upload-area.dragover {
            border-color: #666;
            background: #eee;
        }

        .upload-text {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 0.9em;
            color: #999;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #d0d0d0;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: white;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #f5f5f5;
        }

        .preview-section {
            display: none;
            margin-top: 20px;
        }

        .preview-section.active {
            display: block;
        }

        .preview-info {
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #666;
            font-size: 0.95em;
        }

        .preview-info.converting {
            background: #fff3cd;
            color: #856404;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .preview-item {
            position: relative;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .preview-item.converting {
            opacity: 0.6;
        }

        .preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 3px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
            z-index: 10;
        }

        .preview-item .remove-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .preview-item .filename {
            padding: 8px;
            font-size: 0.8em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: white;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-content {
            background: white;
            padding: 40px;
            border-radius: 4px;
            text-align: center;
            min-width: 320px;
            max-width: 520px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #666;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-status {
            color: #666;
            font-size: 0.95em;
            margin-top: 10px;
        }

        .progress-details {
            margin-top: 20px;
            text-align: left;
        }

        .progress-details h4 {
            font-size: 1em;
            color: #444;
            margin-bottom: 10px;
        }

        .progress-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .progress-item {
            padding: 10px 12px;
            border-radius: 4px;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-left: 4px solid #ccc;
        }

        .progress-item .progress-name {
            font-weight: 500;
            color: #333;
        }

        .progress-item .progress-message {
            font-size: 0.9em;
            color: #666;
        }

        .progress-item.status-pending {
            border-left-color: #9e9e9e;
        }

        .progress-item.status-processing {
            border-left-color: #2196f3;
        }

        .progress-item.status-done {
            border-left-color: #4caf50;
        }

        .progress-item.status-error {
            border-left-color: #f44336;
        }

        .progress-empty {
            text-align: center;
            color: #999;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0 10px;
        }

        .progress-fill {
            height: 100%;
            background: #666;
            transition: width 0.3s ease;
            width: 0%;
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .stats-bar {
            background: white;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 300;
            color: #333;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .result-card {
            background: white;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 20px;
            align-items: start;
        }

        .result-image {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .result-image:hover {
            opacity: 0.8;
        }

        .result-info h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 500;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .label {
            font-weight: 500;
            color: #666;
        }

        .value {
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .badge-success {
            background: #4caf50;
            color: white;
        }

        .badge-warning {
            background: #ff9800;
            color: white;
        }

        .badge-error {
            background: #f44336;
            color: white;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .confidence-fill {
            height: 100%;
            background: #666;
            transition: width 0.5s ease;
        }

        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            color: #856404;
        }

        .warning-box strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #ff9800;
        }

        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            padding: 20px;
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            max-width: 480px;
            width: 100%;
        }

        .camera-content video {
            width: 100%;
            border-radius: 8px;
            background: black;
        }

        .camera-content canvas {
            display: none;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 4px;
        }

        .image-modal .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 500;
        }

        .image-modal .close-btn:hover {
            background: #f0f0f0;
        }

        #fileInput, #cameraInput {
            display: none;
        }

        @media (max-width: 768px) {
            .result-card {
                grid-template-columns: 1fr;
            }

            .result-image {
                width: 100%;
                height: 200px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OCR Empfänger-Erkennung</h1>
        </div>

        <div class="upload-section">
            <h2 class="section-title">Bild hochladen</h2>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-text">Bild hier ablegen oder klicken zum Auswählen</div>
                <div class="upload-subtext">Unterstützte Formate: JPG, PNG, HEIC</div>
            </div>

            <input type="file" id="fileInput" accept="image/*,.heic,.heif" multiple>
            <input type="file" id="cameraInput" accept="image/*" capture="environment">

            <div class="button-group">
                <button class="btn btn-primary" id="analyseBtn" disabled>Analyse starten</button>
                <button class="btn btn-secondary" id="cameraBtn">Kamera öffnen</button>
                <button class="btn btn-secondary" id="resetBtn" disabled>Zurücksetzen</button>
            </div>

            <div class="preview-section" id="previewSection">
                <div class="preview-info" id="previewInfo"></div>
                <div class="preview-grid" id="previewGrid"></div>
            </div>
        </div>

        <div class="processing-overlay" id="processingOverlay">
            <div class="processing-content">
                <div class="spinner"></div>
                <h3>Bilder werden verarbeitet...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="processing-status" id="processingStatus">0 von 0 abgeschlossen</p>
                <div class="progress-details">
                    <h4>Fortschritt je Bild</h4>
                    <div class="progress-list" id="progressList"></div>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="stats-bar" id="statsBar"></div>
            <div id="resultsContainer"></div>
        </div>

        <div class="camera-modal" id="cameraModal">
            <div class="camera-content">
                <video id="cameraVideo" autoplay playsinline></video>
                <canvas id="cameraCanvas"></canvas>
                <div class="camera-controls">
                    <button class="btn btn-primary" id="captureBtn">Foto aufnehmen</button>
                    <button class="btn btn-secondary" id="closeCameraBtn">Abbrechen</button>
                </div>
            </div>
        </div>

        <div class="image-modal" id="imageModal">
            <button class="close-btn" onclick="closeImageModal()">Schließen</button>
            <img id="modalImage" src="" alt="Vergrößertes Bild">
        </div>
    </div>

    <script>
        let selectedImages = [];
        let convertingCount = 0;
        let progressInterval = null;
        let cameraStream = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const analyseBtn = document.getElementById('analyseBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        const resetBtn = document.getElementById('resetBtn');
        const previewSection = document.getElementById('previewSection');
        const previewInfo = document.getElementById('previewInfo');
        const previewGrid = document.getElementById('previewGrid');
        const progressList = document.getElementById('progressList');
        const cameraModal = document.getElementById('cameraModal');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const captureBtn = document.getElementById('captureBtn');
        const closeCameraBtn = document.getElementById('closeCameraBtn');

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        cameraBtn.addEventListener('click', async () => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    await openCameraModal();
                } catch (error) {
                    console.error('Kamera konnte nicht geöffnet werden:', error);
                    cameraInput.click();
                }
            } else {
                cameraInput.click();
            }
        });

        cameraInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        if (captureBtn) {
            captureBtn.addEventListener('click', () => {
                capturePhoto();
            });
        }

        if (closeCameraBtn) {
            closeCameraBtn.addEventListener('click', () => {
                closeCameraModal();
            });
        }

        if (cameraModal) {
            cameraModal.addEventListener('click', (event) => {
                if (event.target === cameraModal) {
                    closeCameraModal();
                }
            });
        }

        resetBtn.addEventListener('click', () => {
            if (confirm('Alle ausgewählten Bilder löschen?')) {
                selectedImages = [];
                convertingCount = 0;
                updatePreview();
                document.getElementById('resultsSection').classList.remove('active');
                fileInput.value = '';
                cameraInput.value = '';
            }
        });

        analyseBtn.addEventListener('click', processImages);

        async function openCameraModal() {
            if (!cameraModal) return;

            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: 'environment' } },
                    audio: false
                });
                cameraVideo.srcObject = cameraStream;
                cameraModal.classList.add('active');
            } catch (error) {
                stopCameraStream();
                throw error;
            }
        }

        function stopCameraStream() {
            if (cameraStream) {
                const tracks = cameraStream.getTracks();
                tracks.forEach(track => track.stop());
                cameraStream = null;
            }
            if (cameraVideo) {
                cameraVideo.srcObject = null;
            }
        }

        function closeCameraModal() {
            if (!cameraModal) return;
            cameraModal.classList.remove('active');
            stopCameraStream();
        }

        function capturePhoto() {
            if (!cameraVideo || !cameraCanvas) return;

            const videoWidth = cameraVideo.videoWidth || 1280;
            const videoHeight = cameraVideo.videoHeight || 720;

            cameraCanvas.width = videoWidth;
            cameraCanvas.height = videoHeight;

            const context = cameraCanvas.getContext('2d');
            context.drawImage(cameraVideo, 0, 0, videoWidth, videoHeight);

            const dataUrl = cameraCanvas.toDataURL('image/jpeg', 0.9);
            const base64Data = dataUrl.split(',')[1];
            const filename = `kamera-${new Date().toISOString().replace(/[:.]/g, '-')}.jpg`;

            selectedImages.push({
                file: null,
                base64: base64Data,
                preview: dataUrl,
                name: filename,
                isHeic: false,
                converting: false
            });

            updatePreview();
            closeCameraModal();
        }

        function isHeicFile(file) {
            const name = file.name.toLowerCase();
            const type = file.type.toLowerCase();
            return name.endsWith('.heic') ||
                   name.endsWith('.heif') ||
                   type === 'image/heic' || 
                   type === 'image/heif';
        }

        async function convertHeicImage(base64Data, fileName) {
            try {
                const response = await fetch('/ocr/convert-heic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        img_body_base64: base64Data
                    })
                });

                if (!response.ok) {
                    throw new Error(`Konvertierung fehlgeschlagen: ${response.status}`);
                }

                const data = await response.json();
                return data.converted_base64;
            } catch (error) {
                console.error(`Fehler bei HEIC-Konvertierung von ${fileName}:`, error);
                alert(`HEIC-Konvertierung fehlgeschlagen für ${fileName}. Verarbeitung wird trotzdem versucht.`);
                return null;
            }
        }

        async function handleFiles(files) {
            const filesArray = Array.from(files);
            
            for (const file of filesArray) {
                const isImage = file.type.startsWith('image/') || 
                               file.name.match(/\.(jpg|jpeg|png|heic|heif|webp|gif)$/i);
                
                if (isImage) {
                    const reader = new FileReader();
                    const isHeic = isHeicFile(file);
                    
                    reader.onload = async function(e) {
                        const base64Data = e.target.result.split(',')[1];
                        const tempIndex = selectedImages.length;
                        
                        selectedImages.push({
                            file: file,
                            base64: base64Data,
                            preview: null,
                            name: file.name,
                            isHeic: isHeic,
                            converting: isHeic
                        });
                        
                        updatePreview();
                        
                        if (isHeic) {
                            convertingCount++;
                            updateConvertingStatus();
                            
                            const convertedBase64 = await convertHeicImage(base64Data, file.name);
                            
                            if (convertedBase64) {
                                selectedImages[tempIndex].preview = `data:image/jpeg;base64,${convertedBase64}`;
                                selectedImages[tempIndex].base64 = convertedBase64;
                                const originalName = file.name || `Bild_${tempIndex + 1}.heic`;
                                const jpgName = originalName.includes('.')
                                    ? originalName.replace(/\.[^/.]+$/, '.jpg')
                                    : `${originalName}.jpg`;
                                selectedImages[tempIndex].name = jpgName;
                                selectedImages[tempIndex].converting = false;
                            } else {
                                selectedImages[tempIndex].converting = false;
                            }
                            
                            convertingCount--;
                            updateConvertingStatus();
                            updatePreview();
                        } else {
                            selectedImages[tempIndex].preview = e.target.result;
                            updatePreview();
                        }
                    };
                    
                    reader.onerror = function(error) {
                        console.error(`Fehler beim Lesen von ${file.name}:`, error);
                        alert(`Fehler beim Lesen der Datei: ${file.name}`);
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }

        function updateConvertingStatus() {
            if (convertingCount > 0) {
                previewInfo.classList.add('converting');
            } else {
                previewInfo.classList.remove('converting');
            }
        }

        function updatePreview() {
            if (selectedImages.length === 0) {
                previewSection.classList.remove('active');
                analyseBtn.disabled = true;
                resetBtn.disabled = true;
                return;
            }

            previewSection.classList.add('active');
            analyseBtn.disabled = convertingCount > 0;
            resetBtn.disabled = false;

            const count = selectedImages.length;
            const heicCount = selectedImages.filter(img => img.isHeic).length;
            
            let infoText = `${count} Bild${count !== 1 ? 'er' : ''} ausgewählt`;
            if (convertingCount > 0) {
                infoText += ` - ${convertingCount} HEIC-Bild${convertingCount !== 1 ? 'er' : ''} wird konvertiert...`;
            } else if (heicCount > 0) {
                infoText += ` (${heicCount} HEIC-Bild${heicCount !== 1 ? 'er' : ''} konvertiert)`;
            }
            previewInfo.textContent = infoText;

            previewGrid.innerHTML = '';
            selectedImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                
                if (img.converting) {
                    div.classList.add('converting');
                }
                
                if (img.preview) {
                    div.innerHTML = `
                        <img src="${img.preview}" alt="${img.name}">
                        <button class="remove-btn" onclick="removeImage(${index})">×</button>
                        <div class="filename">${img.name}</div>
                    `;
                } else {
                    div.innerHTML = `
                        <div style="height: 120px; display: flex; align-items: center; justify-content: center; background: #f0f0f0;">
                            <div style="text-align: center; color: #666;">
                                <div style="font-size: 2em; margin-bottom: 10px;">⏳</div>
                                <div style="font-size: 0.85em;">Wird konvertiert...</div>
                            </div>
                        </div>
                        <button class="remove-btn" onclick="removeImage(${index})">×</button>
                        <div class="filename">${img.name}</div>
                    `;
                }
                
                previewGrid.appendChild(div);
            });
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            updatePreview();
        }

        function renderProgressItems(items) {
            if (!progressList) return;

            progressList.innerHTML = '';

            if (!items || items.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'progress-empty';
                emptyState.textContent = 'Warte auf Fortschritt...';
                progressList.appendChild(emptyState);
                return;
            }

            items.forEach((item, index) => {
                const entry = document.createElement('div');
                entry.className = `progress-item status-${item.status || 'pending'}`;

                const nameDiv = document.createElement('div');
                nameDiv.className = 'progress-name';
                nameDiv.textContent = item.filename || `Bild ${index + 1}`;

                const messageDiv = document.createElement('div');
                messageDiv.className = 'progress-message';
                messageDiv.textContent = item.message || '';

                entry.appendChild(nameDiv);
                entry.appendChild(messageDiv);

                progressList.appendChild(entry);
            });
        }

        function initializeProgressItems() {
            const items = selectedImages.map((img, index) => ({
                status: 'pending',
                filename: img.name || `Bild ${index + 1}`,
                message: 'Wartet auf Verarbeitung'
            }));
            renderProgressItems(items);
        }

        function clearProgressItems() {
            if (!progressList) return;
            progressList.innerHTML = '';
        }

        async function fetchProgress() {
            try {
                const response = await fetch('/ocr/batch-progress');
                const data = await response.json();

                if (data.processing) {
                    const progressFill = document.getElementById('progressFill');
                    const processingStatus = document.getElementById('processingStatus');

                    progressFill.style.width = `${data.percentage}%`;
                    processingStatus.textContent = `${data.current} von ${data.total} abgeschlossen`;
                    if (data.items) {
                        renderProgressItems(data.items);
                    }
                }
            } catch (error) {
                console.error('Error fetching progress:', error);
            }
        }

        async function processImages() {
            if (selectedImages.length === 0) return;
            if (convertingCount > 0) {
                alert('Bitte warten Sie, bis alle HEIC-Bilder konvertiert wurden.');
                return;
            }

            const overlay = document.getElementById('processingOverlay');
            const progressFill = document.getElementById('progressFill');
            const processingStatus = document.getElementById('processingStatus');
            
            overlay.classList.add('active');
            progressFill.style.width = '0%';
            processingStatus.textContent = `0 von ${selectedImages.length} abgeschlossen`;
            initializeProgressItems();

            // Start polling for progress
            progressInterval = setInterval(fetchProgress, 500);

            const payload = selectedImages.map((img, index) => ({
                img_body_base64: img.base64,
                filename: img.name || `Bild ${index + 1}`
            }));

            try {
                const response = await fetch('/ocr/upload-images-batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Stop polling
                clearInterval(progressInterval);
                progressInterval = null;
                
                // Set to 100%
                progressFill.style.width = '100%';
                processingStatus.textContent = `${data.images_processed} von ${data.images_processed} abgeschlossen`;
                
                displayResults(data);
            } catch (error) {
                console.error('Error:', error);
                alert('Fehler bei der Verarbeitung: ' + error.message);
            } finally {
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                overlay.classList.remove('active');
                clearProgressItems();
            }
        }

        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.classList.add('active');
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
        }

        // Close modal on click outside image
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // Close modal on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (cameraModal && cameraModal.classList.contains('active')) {
                    closeCameraModal();
                } else {
                    closeImageModal();
                }
            }
        });

        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const statsBar = document.getElementById('statsBar');
            const resultsContainer = document.getElementById('resultsContainer');

            statsBar.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${data.images_processed}</div>
                    <div class="stat-label">Bilder verarbeitet</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.successful_matches}</div>
                    <div class="stat-label">Erfolgreiche Matches</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.failed_matches}</div>
                    <div class="stat-label">Fehlgeschlagen</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.total_processing_time_seconds}s</div>
                    <div class="stat-label">Verarbeitungszeit</div>
                </div>
            `;

            resultsContainer.innerHTML = '';

            data.results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';

                let statusBadge = '';
                if (result.success) {
                    if (result.matched_from_list) {
                        statusBadge = '<span class="badge badge-success">Empfänger gefunden</span>';
                    } else {
                        statusBadge = '<span class="badge badge-warning">Kein Match</span>';
                    }
                } else {
                    statusBadge = '<span class="badge badge-error">Fehler</span>';
                }

                const warningMessage = result.warning 
                    ? `<div class="warning-box">
                        ${result.warning}
                       </div>`
                    : '';

                const imageSrc = `data:image/jpeg;base64,${result.image_base64}`;
                const displayName = result.filename || `Bild ${index + 1}`;

                card.innerHTML = `
                    <img src="${imageSrc}"
                         alt="Bild ${index + 1}"
                         class="result-image"
                         onclick="openImageModal('${imageSrc}')">
                    <div class="result-info">
                        <h3>Bild ${index + 1} ${statusBadge}</h3>

                        ${result.success ? `
                            <div class="info-row">
                                <span class="label">Datei:</span>
                                <span class="value">${displayName}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Empfänger:</span>
                                <span class="value"><strong>${result.recipient}</strong></span>
                            </div>
                            <div class="info-row">
                                <span class="label">Konfidenz:</span>
                                <span class="value">${result.confidence}%</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${result.confidence}%"></div>
                            </div>
                            <div class="info-row">
                                <span class="label">Methode:</span>
                                <span class="value">${result.method}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Bildqualität:</span>
                                <span class="value">${result.quality_score}/100</span>
                            </div>
                            ${warningMessage}
                        ` : `
                            <div class="info-row">
                                <span class="label">Datei:</span>
                                <span class="value">${displayName}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Fehler:</span>
                                <span class="value" style="color: #f44336;">${result.error}</span>
                            </div>
                        `}
                    </div>
                `;

                resultsContainer.appendChild(card);
            });

            resultsSection.classList.add('active');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        window.removeImage = removeImage;
        window.openImageModal = openImageModal;
        window.closeImageModal = closeImageModal;
    </script>
</body>
</html>